<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Detalle Producto | Anmago Store</title>
  <meta name="description" content="Descubre este producto exclusivo en Anmago Store. Calidad garantizada y los mejores precios.">
  <!-- Preconexiones optimizadas -->
  <link rel="preconnect" href="https://cdn.jsdelivr.net">
  <link rel="preconnect" href="https://ik.imagekit.io">
  <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">
    <!-- PWA y favicon -->
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="logo.jpg" type="image/x-icon" />

  <!-- Bootstrap e iconos -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" />

  <!-- CSS optimizado -->
  <link rel="stylesheet" href="ESTILO.CSS?v=20251207" />
  
  </head>
<body class="bg-light">
  <!-- Scripts optimizados -->
  <script src="carrito.js?v=20251207"></script>
  <script src="app.js?v=20251207"></script>

 <header class="header-sticky d-flex justify-content-between align-items-center px-3 py-2">
  <!-- LOGO -->
  <div class="logo">
    <a href="INICIO.HTML" id="logo-inicio" onclick="volverAInicio()">
      <img
        src="https://ik.imagekit.io/mbsk9dati/logo.jpg?tr=w-48,h-48"
        alt="ANMAGO STORE"
        width="48"
        height="48"
        loading="lazy"
        style="display: block; object-fit: contain; border-radius: 6px;"
      />
    </a>
  </div>
 </header>

  <!-- BANNER PROMOCIONAL -->
  <div class="container-fluid banner-promocional py-2">
    <div class="container text-center">
      <small class="fw-bold">‚≠ê Los mejores precios ‚≠ê Calidad garantizada</small>
    </div>
  </div>

  <!-- BOT√ìN INSTALAR APP -->
  <div id="instalar-container" class="instalar-container d-none">
    <button id="boton-instalar" class="btn-instalar-app">
      <i class="bi bi-download"></i> Instalar App
    </button>
  </div>

  <!-- BOTONES EN LA MISMA L√çNEA - COMPACTO -->
  <div class="container mt-3">
    <div class="row align-items-center">
      <!-- Bot√≥n Volver atr√°s (izquierda) -->
      <div class="col text-start">
        <a href="#" id="btn-volver-atras" class="btn btn-outline-dark btn-sm" onclick="volverAtras()">
          <i class="bi bi-arrow-left"></i> Volver
        </a>
      </div>

      <!-- Bot√≥n Ofertas Especiales (derecha) -->
      <div class="col text-end">
        <a href="PROMOS.HTML" class="btn btn-warning fw-bold px-3 py-2 rounded-pill">
          üéÅ Ofertas
        </a>
      </div>
    </div>
  </div>

  <!-- CONTENIDO PRINCIPAL - DETALLE PRODUCTO -->
  <main class="container mt-4">
    
    <!-- T√çTULO Y PRECIO PARA M√ìVIL (ARRIBA DE TODO) -->
    <div class="d-block d-md-none mb-4">
      <!-- Categor√≠as -->
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb" id="breadcrumb-producto-mobile">
          <li class="breadcrumb-item"><a href="INICIO.HTML">ATR√ÅS</a></li>
          <!-- Categor√≠as se cargan din√°micamente -->
        </ol>
      </nav>

      <!-- Nombre y precio -->
      <h1 id="nombre-producto-mobile" class="h3 fw-bold mb-2"></h1>
      <div class="d-flex align-items-center gap-3 mb-3">
        <span id="precio-actual-mobile" class="h4 fw-bold text-primary mb-0"></span>
        <span id="precio-original-mobile" class="text-muted h5 mb-0 text-decoration-line-through"></span>
        <span id="descuento-mobile" class="badge badge-oferta fs-6"></span>
      </div>
    </div>

    <div class="row">
      <!-- GALER√çA DE IM√ÅGENES CON ZOOM -->
      <div class="col-md-6 mb-4">
        <div class="sticky-top" style="top: 100px;">
          <!-- IMAGEN PRINCIPAL CON ZOOM MEJORADA -->
          <div class="position-relative mb-3">
            <img id="imagen-principal" src="" alt="Producto" 
                 class="card-img-ml shadow img-fluid"
                 style="cursor: zoom-in; max-height: 500px; width: 100%; object-fit: contain; transition: all 0.3s ease; border-radius: 12px;"
                 onmouseover="this.style.transform='scale(1.02)'; this.style.boxShadow='0 8px 25px rgba(0,0,0,0.15)'"
                 onmouseout="this.style.transform='scale(1)'; this.style.boxShadow=''"
                 data-bs-toggle="modal" data-bs-target="#modalZoom">
            
            <!-- Indicador de zoom -->
            <div class="position-absolute top-0 end-0 m-3">
              <div class="bg-dark bg-opacity-75 rounded-circle p-2 d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                <i class="bi bi-zoom-in text-white fs-6"></i>
              </div>
            </div>
            
            <!-- Texto ayuda -->
            <div class="position-absolute bottom-0 start-0 end-0 text-center mb-2">
              <small class="badge bg-dark bg-opacity-75 text-white px-3 py-2">
                <i class="bi bi-mouse"></i> Clic para ampliar ‚Ä¢ 
                <i class="bi bi-arrows-fullscreen"></i> Doble clic para zoom m√°ximo
              </small>
            </div>
          </div>
          
          <!-- GALER√çA DE TODAS LAS IM√ÅGENES -->
          <div class="galeria-miniaturas" id="galeria-miniaturas">
            <!-- Todas las im√°genes se cargan din√°micamente (PRINCIPAL + VARIANTES + REFERENCIAS) -->
          </div>

          <!-- Badges de estado -->
          <div class="mt-3" id="badges-producto">
            <!-- Badges se cargan din√°micamente -->
          </div>

          <!-- VIDEO DEL PRODUCTO EN DESKTOP (debajo de las im√°genes) -->
          <!-- SOLO SE MUESTRA EN DESKTOP -->
          <div id="video-producto-desktop" class="d-none d-md-block mt-4"></div>
        </div>
      </div>

      <!-- INFORMACI√ìN DEL PRODUCTO -->
      <div class="col-md-6">
        <div class="ps-md-4">
          <!-- T√çTULO Y PRECIO PARA DESKTOP (DENTRO DE LA COLUMNA) -->
          <div class="d-none d-md-block">
            <!-- Categor√≠as -->
            <nav aria-label="breadcrumb">
              <ol class="breadcrumb" id="breadcrumb-producto-desktop">
                <li class="breadcrumb-item"><a href="INICIO.HTML">ATR√ÅS</a></li>
                <!-- Categor√≠as se cargan din√°micamente -->
              </ol>
            </nav>

            <!-- Nombre y precio -->
            <h1 id="nombre-producto-desktop" class="h3 fw-bold mb-2"></h1>
            <div class="d-flex align-items-center gap-3 mb-3">
              <span id="precio-actual-desktop" class="h4 fw-bold text-primary mb-0"></span>
              <span id="precio-original-desktop" class="text-muted h5 mb-0 text-decoration-line-through"></span>
              <span id="descuento-desktop" class="badge badge-oferta fs-6"></span>
            </div>
          </div>

          <!-- VIDEO DEL PRODUCTO EN M√ìVIL (antes de la descripci√≥n) -->
          <!-- SOLO SE MUESTRA EN M√ìVIL -->
          <div id="video-producto-mobile" class="d-block d-md-none mb-4"></div>

          <!-- VARIANTE ACTUAL (se muestra cuando se selecciona imagen) -->
          <div class="mb-3" id="variante-actual-container" style="display: none;">
            <h5 class="fw-bold mb-2">üé® COLOR SELECCIONADO</h5>
            <div class="alert alert-info py-2">
              <span id="variante-actual-texto"></span>
            </div>
          </div>
               
          <!-- SELECTOR DE VARIABLES (COLORES/MATERIALES) -->
          <div class="mb-4" id="seccion-variables">
            <!-- Selector de variables se carga din√°micamente -->
          </div>

          <!-- SELECTOR DE TALLAS -->
          <div class="mb-4" id="seccion-tallas">
            <!-- Selector de tallas se carga din√°micamente -->
          </div>

          <!-- Cantidad -->
          <div class="mb-4">
            <h5 class="fw-bold mb-3">üî¢ Cantidad</h5>
            <div class="d-flex align-items-center gap-3">
              <button class="btn btn-outline-secondary" onclick="cambiarCantidad(-1)">-</button>
              <input type="number" id="input-cantidad" class="form-control text-center" value="1" min="1" max="10" style="width: 80px;">
              <button class="btn btn-outline-secondary" onclick="cambiarCantidad(1)">+</button>
            </div>
          </div>

          <!-- Botones de acci√≥n -->
          <div class="d-grid gap-2 d-md-flex mb-4">
            <button id="btn-agregar-carrito" class="btn btn-agregar-carrito btn-lg flex-fw-bold" onclick="agregarAlCarrito()" disabled>
              <i class="bi bi-cart-plus"></i> Agregar al carrito
            </button>
            <button class="btn btn-gradient btn-lg" onclick="comprarAhora()" disabled>
              <i class="bi bi-lightning"></i> Comprar ahora
            </button>
          </div>

          <!-- Descripci√≥n -->
          <div class="mb-4">
            <h5 class="fw-bold mb-2">üìã Descripci√≥n</h5>
            <p id="descripcion-producto" class="text-muted"></p>
          </div>

          <!-- SERVICIOS -->
          <div class="card border-0 bg-light">
            <div class="card-body">
              <div class="row text-center">
                <div class="col-4">
                  <i class="bi bi-shield-check text-primary fs-4"></i>
                  <div class="small mt-1">Calidad</div>
                </div>
                <div class="col-4">
                  <i class="bi bi-star text-primary fs-4"></i>
                  <div class="small mt-1">Garant√≠a</div>
                </div>
                <div class="col-4">
                  <i class="bi bi-percent text-primary fs-4"></i>
                  <div class="small mt-1">PROMOS</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- PRODUCTOS RELACIONADOS -->
    <section class="mt-5 pt-4 border-top">
      <h3 class="h4 fw-bold mb-4">üõçÔ∏è Productos relacionados</h3>
      <div id="productos-relacionados" class="grid-productos-ml">
        <!-- Productos relacionados se cargan din√°micamente -->
        <div class="card-producto-ml skeleton" style="height: 280px;"></div>
        <div class="card-producto-ml skeleton" style="height: 280px;"></div>
        <div class="card-producto-ml skeleton" style="height: 280px;"></div>
        <div class="card-producto-ml skeleton" style="height: 280px;"></div>
      </div>
    </section>
  </main>

  <!-- CARRITO OFFCANVAS -->
  <div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasCarrito">
    <div class="offcanvas-header border-bottom">
      <h4 class="offcanvas-title fw-bold">üõí Tu Carrito</h4>
      <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Cerrar"></button>
    </div>
    <div class="offcanvas-body" id="carrito-contenido">
      <div class="text-center text-muted py-4">
        <i class="bi bi-bag-x fs-1"></i>
        <p class="mt-2">Tu carrito est√° vac√≠o</p>
      </div>
    </div>
    <div class="offcanvas-footer p-3 border-top">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <span class="fw-bold">Subtotal:</span>
        <span id="subtotal" class="fw-bold fs-5 text-primary">$0</span>
      </div>
      <button class="btn btn-gradient px-4 py-2 rounded-pill fw-bold" onclick="abrirFormularioPedido()">
        ‚ú®Continuar compra‚ú®
      </button>
    </div>
  </div>

  <!-- MODAL DE ZOOM MEJORADO -->
  <div class="modal fade" id="modalZoom" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-xl">
      <div class="modal-content">
        <div class="modal-header border-0">
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body p-0">
          <div class="row g-0">
            <div class="col-md-9">
              <div class="position-relative" style="min-height: 500px;">
                <img id="modal-zoom-imagen" src="" alt="" class="img-fluid w-100 h-100" style="object-fit: contain;">
                <div class="position-absolute top-50 start-0 translate-middle-y">
                  <button class="btn btn-dark rounded-circle p-2 ms-2" onclick="navegarImagenModal(-1)" id="btn-prev">
                    <i class="bi bi-chevron-left"></i>
                  </button>
                </div>
                <div class="position-absolute top-50 end-0 translate-middle-y">
                  <button class="btn btn-dark rounded-circle p-2 me-2" onclick="navegarImagenModal(1)" id="btn-next">
                    <i class="bi bi-chevron-right"></i>
                  </button>
                </div>
              </div>
            </div>
            <div class="col-md-3 bg-light p-3">
              <div class="mb-3">
                <h6 class="fw-bold">Miniaturas</h6>
                <div class="d-flex flex-wrap gap-2" id="modal-miniaturas"></div>
              </div>
              <div class="mb-3">
                <h6 class="fw-bold">Informaci√≥n</h6>
                <p id="modal-variante-info" class="small mb-0"></p>
              </div>
              <button class="btn btn-primary w-100" onclick="seleccionarDesdeModal()">
                <i class="bi bi-check-circle"></i> Seleccionar este color
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- BOT√ìN CARRITO FLOTANTE -->
  <a href="#" class="btn-carrito-flotante d-none d-md-flex" data-bs-toggle="offcanvas" data-bs-target="#offcanvasCarrito">
    <i class="bi bi-bag-heart fs-5"></i>
    <span id="contador-carrito" class="contador-carrito">0</span>
  </a>

  <!-- FOOTER -->
  <div id="footer-container" class="mt-5"></div>

  <!-- BARRA INFERIOR MOBILE -->
  <nav class="navbar fixed-bottom bg-white border-top d-md-none py-2">
    <div class="container-fluid">
      <div class="d-flex justify-content-around w-100">
        <a href="INICIO.HTML" class="text-center text-decoration-none text-primary">
          <i class="bi bi-house-fill fs-5"></i>
          <div class="small">Inicio</div>
        </a>
        <a href="PROMOS.HTML" class="text-center text-decoration-none text-dark">
          <i class="bi bi-percent fs-5"></i>
          <div class="small">Ofertas</div>
        </a>
        <a href="#" class="text-center text-decoration-none position-relative"
           data-bs-toggle="offcanvas" data-bs-target="#offcanvasCarrito">
          <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center" 
               style="width: 50px; height: 50px; margin-top: -8px;">
            <i class="bi bi-bag-heart fs-5 text-white"></i>
          </div>
          <span id="contador-carrito-mobile" class="position-absolute top-0 start-100 translate-middle badge bg-danger rounded-pill" style="font-size: 0.6rem;">0</span>
          <div class="small mt-1">Carrito</div>
        </a>
        <a href="https://wa.me/573006498710?text=¬°Hola!%20Me%20interesan%20sus%20productos%20de%20Anmago%20Store" 
           class="text-center text-decoration-none text-success"
           target="_blank">
          <i class="bi bi-whatsapp fs-5"></i>
          <div class="small">Chat</div>
        </a>
        <a href="modalformulario.html" class="text-center text-decoration-none text-dark">
          <i class="bi bi-person fs-5"></i>
          <div class="small">Cuenta</div>
        </a>
      </div>
    </div>
  </nav>

  <!-- SISTEMA DE DETALLE PRODUCTO OPTIMIZADO -->
  <script>
    // ========== VARIABLES GLOBALES OPTIMIZADAS ==========
    let productoActual = null;
    let varianteSeleccionada = '';
    let variableSeleccionada = '';
    let tallaSeleccionada = '';
    let imagenSeleccionada = '';
    let cantidad = 1;
    let promocionesGlobal = [];
    let imagenesProducto = [];
    let zoomIndex = 0;

    // ========== FUNCIONES AUXILIARES PARA IM√ÅGENES ==========
    function obtenerImagenesPorTipo(tipo) {
        if (!imagenesProducto || !Array.isArray(imagenesProducto)) return [];
        return imagenesProducto.filter(img => 
            img.tipo && img.tipo.toUpperCase() === tipo.toUpperCase()
        );
    }

    // ========== SISTEMA DE PROMOCIONES ==========
    function vieneDePromociones() {
        const urlParams = new URLSearchParams(window.location.search);
        const origen = urlParams.get('origen');
        return origen === 'promos' || origen === 'home' || window.location.pathname.includes('PROMOS');
    }

    function obtenerIndicePromocional(totalPromos = 0) {
        const ahora = new Date();
        const horaActual = ahora.getHours();
        const bloque = Math.floor(horaActual / 6);
        const indice = bloque * 8;
        return totalPromos > 0 ? indice % totalPromos : indice;
    }

    function estaEnPromocionActual(productoId) {
        if (!promocionesGlobal || !Array.isArray(promocionesGlobal)) return false;
        const totalPromos = promocionesGlobal.length;
        if (totalPromos === 0) return false;
        
        const indiceActual = obtenerIndicePromocional(totalPromos);
        const bloqueActual = promocionesGlobal.slice(indiceActual, indiceActual + 8);
        
        return bloqueActual.some(promo => promo.id === productoId);
    }

    function calcularPrecioConDescuento(producto) {
        const precioBase = producto.precio || 0;
        
        if (vieneDePromociones()) {
            return Math.round(precioBase * 0.9);
        }
        
        if (estaEnPromocionActual(producto.id)) {
            return Math.round(precioBase * 0.9);
        }
        
        return precioBase;
    }

    // ========== SISTEMA DE NAVEGACI√ìN ==========
    function volverAtras() {
        const estadoGuardado = localStorage.getItem('navegacionAnmago');
        
        if (estadoGuardado) {
            try {
                const estado = JSON.parse(estadoGuardado);
                const ahora = Date.now();
                const tiempoTranscurrido = ahora - estado.timestamp;
                
                if (tiempoTranscurrido < 30 * 60 * 1000) {
                    let urlRetorno = 'INICIO.HTML';
                    
                    switch (estado.vistaAnterior) {
                        case 'productos':
                            if (estado.tipo && estado.subtipo && estado.categoria) {
                                urlRetorno = `INICIO.HTML?vista=productos&tipo=${encodeURIComponent(estado.tipo)}&subtipo=${encodeURIComponent(estado.subtipo)}&categoria=${encodeURIComponent(estado.categoria)}`;
                            }
                            break;
                        case 'categorias':
                            if (estado.tipo && estado.subtipo) {
                                urlRetorno = `INICIO.HTML?vista=categorias&tipo=${encodeURIComponent(estado.tipo)}&subtipo=${encodeURIComponent(estado.subtipo)}`;
                            }
                            break;
                        case 'subtipos':
                            if (estado.tipo) {
                                urlRetorno = `INICIO.HTML?vista=subtipos&tipo=${encodeURIComponent(estado.tipo)}`;
                            }
                            break;
                    }
                    
                    window.location.href = urlRetorno;
                    return;
                } else {
                    localStorage.removeItem('navegacionAnmago');
                }
            } catch (error) {
                localStorage.removeItem('navegacionAnmago');
            }
        }
        
        window.location.href = 'INICIO.HTML';
    }

    function guardarEstadoNavegacion() {
        const urlParams = new URLSearchParams(window.location.search);
        const origen = urlParams.get('origen');
        const tipo = urlParams.get('tipo');
        const subtipo = urlParams.get('subtipo');
        const categoria = urlParams.get('categoria');
        
        if (origen === 'tienda' && tipo && subtipo && categoria) {
            const estadoNavegacion = {
                vistaAnterior: 'productos',
                tipo: tipo,
                subtipo: subtipo,
                categoria: categoria,
                timestamp: Date.now(),
                url: document.referrer
            };
            localStorage.setItem('navegacionAnmago', JSON.stringify(estadoNavegacion));
        }
    }

    // ========== FUNCIONES PARA GALER√çA PRINCIPAL (TODAS LAS IM√ÅGENES) ==========
    function renderizarGaleriaCompleta(producto) {
        const imagenPrincipal = document.getElementById('imagen-principal');
        const galeria = document.getElementById('galeria-miniaturas');
        
        if (imagenesProducto.length === 0) {
            imagenPrincipal.src = 'https://ik.imagekit.io/mbsk9dati/placeholder-producto.jpg';
            imagenPrincipal.alt = producto.producto;
            return;
        }

        // üéØ OBTENER IMAGEN PRINCIPAL (PRINCIPAL o primera VARIANTE)
        let imagenPrincipalObj = obtenerImagenesPorTipo('PRINCIPAL')[0];
        if (!imagenPrincipalObj) {
            imagenPrincipalObj = obtenerImagenesPorTipo('VARIANTE')[0] || imagenesProducto[0];
        }

        // SETEAR IMAGEN PRINCIPAL
        imagenPrincipal.src = imagenPrincipalObj.url;
        imagenPrincipal.alt = `${producto.producto} - ${imagenPrincipalObj.variacion || 'Imagen principal'}`;
        
        // ACTUALIZAR VARIABLES GLOBALES
        varianteSeleccionada = imagenPrincipalObj.variacion || 'Principal';
        imagenSeleccionada = imagenPrincipalObj.url;
        zoomIndex = imagenesProducto.findIndex(img => img.url === imagenPrincipalObj.url);
        
        // RENDERIZAR GALER√çA CON TODAS LAS IM√ÅGENES
        if (imagenesProducto.length > 1) {
            galeria.innerHTML = imagenesProducto.map((img, index) => {
                const esSeleccionada = img.url === imagenPrincipalObj.url;
                const tipoBadge = getTipoBadge(img.tipo);
                const descripcion = img.variacion || 
                    (img.tipo === 'PRINCIPAL' ? 'Principal' : 
                     img.tipo === 'VARIANTE' ? `Variante ${index}` : 
                     `Referencia ${index}`);
                
                return `
                    <div class="position-relative d-inline-block">
                        <img src="${img.url}" 
                             alt="${producto.producto} - ${descripcion}" 
                             class="miniatura ${esSeleccionada ? 'active' : ''}"
                             onclick="seleccionarImagenPrincipal('${img.url}', '${img.variacion || descripcion}', this, ${index})"
                             style="width: 80px; height: 80px; object-fit: cover; border: 2px solid ${esSeleccionada ? '#007bff' : '#ddd'}; border-radius: 8px; cursor: pointer; margin: 5px; transition: all 0.3s ease;"
                             onmouseover="this.style.borderColor='#007bff'"
                             onmouseout="if(!this.classList.contains('active')) this.style.borderColor='#ddd'"
                             title="${descripcion} - ${tipoBadge.texto}">
                        <span class="position-absolute top-0 start-0 badge ${tipoBadge.clase}" style="font-size: 0.6rem; padding: 2px 4px;">
                            ${tipoBadge.texto}
                        </span>
                    </div>
                `;
            }).join('');
        } else {
            galeria.innerHTML = '';
        }

        // MOSTRAR VARIANTE SI ES VARIANTE
        if (imagenPrincipalObj.tipo === 'VARIANTE') {
            mostrarVarianteActual(imagenPrincipalObj.variacion);
        }
    }

    function getTipoBadge(tipo) {
        switch(tipo?.toUpperCase()) {
            case 'PRINCIPAL': return { clase: 'bg-primary', texto: 'PRIN' };
            case 'VARIANTE': return { clase: 'bg-success', texto: 'COLOR' };
            case 'ADICIONAL': return { clase: 'bg-secondary', texto: 'REF' };
            default: return { clase: 'bg-info', texto: 'IMG' };
        }
    }

    function seleccionarImagenPrincipal(imagenSrc, descripcion, elemento, index) {
        const imagenPrincipal = document.getElementById('imagen-principal');
        imagenPrincipal.src = imagenSrc;
        imagenPrincipal.alt = `${productoActual.producto} - ${descripcion}`;
        
        // ACTUALIZAR VARIABLES GLOBALES
        imagenSeleccionada = imagenSrc;
        zoomIndex = index;
        
        // SI ES VARIANTE, ACTUALIZAR VARIANTE
        const imgSeleccionada = imagenesProducto[index];
        if (imgSeleccionada.tipo === 'VARIANTE') {
            varianteSeleccionada = imgSeleccionada.variacion || descripcion;
            mostrarVarianteActual(varianteSeleccionada);
        }
        
        // ACTUALIZAR MINIATURAS ACTIVAS
        document.querySelectorAll('.miniatura').forEach(img => {
            img.classList.remove('active');
            img.style.borderColor = '#ddd';
        });
        elemento.classList.add('active');
        elemento.style.borderColor = '#007bff';
        
        // VERIFICAR ESTADO DEL BOT√ìN
        verificarEstadoBotonAgregar();
    }

    function mostrarVarianteActual(nombreVariante) {
        const container = document.getElementById('variante-actual-container');
        const texto = document.getElementById('variante-actual-texto');
        texto.textContent = nombreVariante;
        container.style.display = 'block';
    }

    // ========== FUNCIONES PARA MODAL DE ZOOM ==========
    function inicializarModalZoom() {
        const modalImagen = document.getElementById('modal-zoom-imagen');
        const miniaturasContainer = document.getElementById('modal-miniaturas');
        
        if (!modalImagen || !miniaturasContainer) return;
        
        modalImagen.src = imagenesProducto[zoomIndex]?.url || '';
        const imgActual = imagenesProducto[zoomIndex];
        document.getElementById('modal-variante-info').textContent = 
            imgActual?.variacion || (imgActual?.tipo === 'VARIANTE' ? 'Variante seleccionada' : 'Imagen del producto');
        
        // MINIATURAS EN EL MODAL
        miniaturasContainer.innerHTML = imagenesProducto.map((img, index) => {
            const tipoBadge = getTipoBadge(img.tipo);
            const descripcion = img.variacion || `Imagen ${index + 1}`;
            
            return `
                <div class="position-relative" style="width: 80px;">
                    <img src="${img.url}" 
                         alt="${descripcion}"
                         class="img-thumbnail ${index === zoomIndex ? 'border-primary' : 'border-secondary'}"
                         style="width: 80px; height: 80px; object-fit: cover; cursor: pointer;"
                         onclick="seleccionarImagenModal(${index})"
                         title="${descripcion} - ${tipoBadge.texto}">
                    <span class="position-absolute top-0 start-0 badge ${tipoBadge.clase}" style="font-size: 0.6rem; padding: 2px 4px;">
                        ${tipoBadge.texto}
                    </span>
                </div>
            `;
        }).join('');
        
        actualizarBotonesNavegacionModal();
    }

    function navegarImagenModal(direccion) {
        const nuevoIndex = zoomIndex + direccion;
        if (nuevoIndex >= 0 && nuevoIndex < imagenesProducto.length) {
            zoomIndex = nuevoIndex;
            actualizarModalZoom();
        }
    }

    function seleccionarImagenModal(index) {
        zoomIndex = index;
        actualizarModalZoom();
    }

    function seleccionarDesdeModal() {
        const imgSeleccionada = imagenesProducto[zoomIndex];
        
        // SOLO PERMITIR VARIANTES PARA SELECCI√ìN DE COLOR
        if (imgSeleccionada.tipo !== "VARIANTE") {
            mostrarAlertaTemporal('‚ö†Ô∏è Solo puedes seleccionar im√°genes de color (variantes)', 'warning');
            return;
        }
        
        // ACTUALIZAR IMAGEN PRINCIPAL
        document.getElementById('imagen-principal').src = imgSeleccionada.url;
        
        // ACTUALIZAR VARIABLES GLOBALES
        varianteSeleccionada = imgSeleccionada.variacion;
        imagenSeleccionada = imgSeleccionada.url;
        
        // ACTUALIZAR GALER√çA PRINCIPAL
        const miniaturas = document.querySelectorAll('.miniatura');
        miniaturas.forEach((miniatura, index) => {
            const esSeleccionada = index === zoomIndex;
            miniatura.classList.toggle('active', esSeleccionada);
            miniatura.style.borderColor = esSeleccionada ? '#007bff' : '#ddd';
        });
        
        // MOSTRAR VARIANTE
        mostrarVarianteActual(varianteSeleccionada);
        verificarEstadoBotonAgregar();
        
        // CERRAR MODAL
        const modal = bootstrap.Modal.getInstance(document.getElementById('modalZoom'));
        if (modal) modal.hide();
        
        mostrarAlertaTemporal(`‚úÖ Color seleccionado: "${varianteSeleccionada}"`, 'success');
    }

    function actualizarModalZoom() {
        const modalImagen = document.getElementById('modal-zoom-imagen');
        const miniaturasContainer = document.getElementById('modal-miniaturas');
        
        if (!modalImagen) return;
        
        const imgActual = imagenesProducto[zoomIndex];
        modalImagen.style.opacity = '0.5';
        
        setTimeout(() => {
            modalImagen.src = imgActual.url;
            modalImagen.alt = `${productoActual.producto} - ${imgActual.variacion || 'Imagen'}`;
            modalImagen.style.opacity = '1';
            
            document.getElementById('modal-variante-info').textContent = 
                imgActual.variacion || (imgActual.tipo === 'VARIANTE' ? 'Variante seleccionada' : 'Imagen del producto');
            
            if (miniaturasContainer) {
                miniaturasContainer.querySelectorAll('.img-thumbnail').forEach((img, index) => {
                    img.classList.toggle('border-primary', index === zoomIndex);
                    img.classList.toggle('border-secondary', index !== zoomIndex);
                });
            }
            
            actualizarBotonesNavegacionModal();
        }, 200);
    }

    function actualizarBotonesNavegacionModal() {
        const btnPrev = document.getElementById('btn-prev');
        const btnNext = document.getElementById('btn-next');
        
        if (btnPrev) btnPrev.disabled = zoomIndex === 0;
        if (btnNext) btnNext.disabled = zoomIndex === imagenesProducto.length - 1;
    }

    // ========== FUNCIONES DE INICIALIZACI√ìN ==========
    document.addEventListener('DOMContentLoaded', function() {
        guardarEstadoNavegacion();
        cargarHeaderFooter();
        configurarInteracciones();
        
        const modalZoom = document.getElementById('modalZoom');
        if (modalZoom) {
            modalZoom.addEventListener('show.bs.modal', inicializarModalZoom);
        }
        
        setTimeout(() => {
            cargarProducto();
        }, 500);
        
        actualizarContadoresCarrito();
    });

    function cargarHeaderFooter() {
        Promise.all([
            fetch("HEADER.HTML").then(res => res.text()),
            fetch("footer.html").then(res => res.text())
        ]).then(([header, footer]) => {
            document.getElementById("header-container").innerHTML = header;
            document.getElementById("footer-container").innerHTML = footer;
        }).catch(console.error);
    }

    function configurarInteracciones() {
        const inputCantidad = document.getElementById('input-cantidad');
        if (inputCantidad) {
            inputCantidad.addEventListener('change', function() {
                cantidad = Math.max(1, Math.min(10, parseInt(this.value) || 1));
                this.value = cantidad;
            });
        }
    }

    // ========== FUNCIONES PRINCIPALES ==========
    function obtenerIdProducto() {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get('id');
    }

    async function cargarProducto() {
        const productoId = obtenerIdProducto();
        
        if (!productoId) {
            mostrarError('No se especific√≥ ning√∫n producto');
            return;
        }

        try {
            const url = "https://raw.githubusercontent.com/anmagoS/ANMAGOPWA/main/catalogo.json?t=" + Date.now();
            const respuesta = await fetch(url);
            const productos = await respuesta.json();
            
            productoActual = productos.find(p => p.id === productoId);
            
            if (!productoActual) {
                mostrarError('Producto no encontrado en el cat√°logo');
                return;
            }

            // CARGAR PROMOCIONES
            promocionesGlobal = productos.filter(p => {
                const promo = typeof p.promo === "string" ? p.promo.toLowerCase().trim() : p.promo;
                return promo === true || promo === "true" || promo === "s√≠" || promo === "activo" || promo === "si";
            });

            // INICIALIZAR IM√ÅGENES
            imagenesProducto = [];
            
            if (productoActual.imagenes && Array.isArray(productoActual.imagenes)) {
                imagenesProducto = productoActual.imagenes;
            } else if (productoActual.url && productoActual.url.includes("[]")) {
                const urls = productoActual.url.split("[]").map(u => u.trim()).filter(Boolean);
                imagenesProducto = urls.map((url, index) => ({
                    url: url,
                    tipo: "VARIANTE",
                    variacion: `Variante ${index + 1}`,
                    orden: index + 1
                }));
            } else if (productoActual.imagen) {
                imagenesProducto = [{
                    url: productoActual.imagen,
                    tipo: "VARIANTE",
                    variacion: "Principal",
                    orden: 1
                }];
            }

            // INICIALIZAR VARIABLES
            cantidad = 1;
            zoomIndex = 0;
            const primeraVariante = obtenerImagenesPorTipo('VARIANTE')[0];
            if (primeraVariante) {
                varianteSeleccionada = primeraVariante.variacion || 'Variante 1';
                imagenSeleccionada = primeraVariante.url;
            } else if (imagenesProducto.length > 0) {
                varianteSeleccionada = 'Principal';
                imagenSeleccionada = imagenesProducto[0].url;
            }

            // RENDERIZAR PRODUCTO
            renderizarProducto(productoActual);
            cargarProductosRelacionados(productos, productoActual);

        } catch (error) {
            console.error('Error cargando producto:', error);
            mostrarError('Error al cargar el producto');
            cargarProductoEjemplo(productoId);
        }
    }

    function cargarProductoEjemplo(productoId) {
        const productoEjemplo = {
            id: productoId,
            producto: "Producto de Ejemplo",
            descripcion: "Este es un producto de ejemplo",
            precio: 29900,
            imagenes: [{
                url: "https://ik.imagekit.io/mbsk9dati/placeholder-producto.jpg",
                tipo: "VARIANTE",
                variacion: "Ejemplo",
                orden: 1
            }]
        };
        
        productoActual = productoEjemplo;
        imagenesProducto = productoEjemplo.imagenes;
        varianteSeleccionada = 'Ejemplo';
        imagenSeleccionada = productoEjemplo.imagenes[0].url;
        cantidad = 1;
        zoomIndex = 0;
        
        renderizarProducto(productoEjemplo);
    }

    function renderizarProducto(producto) {
        // INFORMACI√ìN B√ÅSICA
        document.getElementById('nombre-producto-mobile').textContent = producto.producto;
        document.getElementById('nombre-producto-desktop').textContent = producto.producto;
        document.getElementById('descripcion-producto').textContent = producto.descripcion || 'Producto de alta calidad disponible en Anmago Store.';
        
        // PRECIOS
        const precioBase = producto.precio || 0;
        const estaEnPromo = vieneDePromociones() || estaEnPromocionActual(producto.id);
        const precioActual = calcularPrecioConDescuento(producto);
        
        document.getElementById('precio-actual-mobile').textContent = `$${precioActual.toLocaleString('es-CO')}`;
        document.getElementById('precio-actual-desktop').textContent = `$${precioActual.toLocaleString('es-CO')}`;
        
        if (estaEnPromo && precioBase > precioActual) {
            document.getElementById('precio-original-mobile').textContent = `$${precioBase.toLocaleString('es-CO')}`;
            document.getElementById('descuento-mobile').textContent = `-${Math.round((1 - precioActual / precioBase) * 100)}%`;
            document.getElementById('precio-original-mobile').style.display = 'inline';
            document.getElementById('descuento-mobile').style.display = 'inline';
            
            document.getElementById('precio-original-desktop').textContent = `$${precioBase.toLocaleString('es-CO')}`;
            document.getElementById('descuento-desktop').textContent = `-${Math.round((1 - precioActual / precioBase) * 100)}%`;
            document.getElementById('precio-original-desktop').style.display = 'inline';
            document.getElementById('descuento-desktop').style.display = 'inline';
        } else {
            document.getElementById('precio-original-mobile').style.display = 'none';
            document.getElementById('descuento-mobile').style.display = 'none';
            document.getElementById('precio-original-desktop').style.display = 'none';
            document.getElementById('descuento-desktop').style.display = 'none';
        }

        // GALER√çA COMPLETA
        renderizarGaleriaCompleta(producto);

        // BREADCRUMB
        renderizarBreadcrumb(producto);

        // VARIABLES Y TALLAS
        renderizarVariables(producto);
        renderizarTallas(producto);

        // BADGES
        renderizarBadges(producto, estaEnPromo);

        // VIDEO
        renderizarVideo(producto);
    }

    function renderizarBreadcrumb(producto) {
        const breadcrumbMobile = document.getElementById('breadcrumb-producto-mobile');
        const breadcrumbDesktop = document.getElementById('breadcrumb-producto-desktop');
        
        let categorias = [];
        if (producto.tipo) categorias.push(producto.tipo);
        if (producto.categoria) categorias.push(producto.categoria);
        if (producto.subcategoria) categorias.push(producto.subcategoria);
        
        const breadcrumbItems = categorias.map(cat => 
            `<li class="breadcrumb-item"><a href="INICIO.HTML?categoria=${cat}">${cat}</a></li>`
        ).join('');
        
        const breadcrumbFinal = breadcrumbItems + 
            `<li class="breadcrumb-item active" aria-current="page">${producto.producto}</li>`;
        
        if (breadcrumbMobile) breadcrumbMobile.innerHTML = breadcrumbMobile.firstElementChild.outerHTML + breadcrumbFinal;
        if (breadcrumbDesktop) breadcrumbDesktop.innerHTML = breadcrumbDesktop.firstElementChild.outerHTML + breadcrumbFinal;
    }

    function renderizarVariables(producto) {
        const contenedor = document.getElementById('seccion-variables');
        
        const tieneVariables = producto.variables && 
                              producto.variables.trim() !== "" && 
                              producto.variables !== "N/A" &&
                              !["√∫nica", "unica"].includes(producto.variables.toLowerCase());
        
        if (tieneVariables) {
            const variables = producto.variables.split(",").map(v => v.trim()).filter(v => v);
            
            contenedor.innerHTML = `
                <h5 class="fw-bold mb-3">üé® Selecciona color/material</h5>
                <select class="form-select selector-variable" onchange="seleccionarVariable(this.value)" style="max-width: 250px; font-size: 1rem; padding: 10px;">
                    <option value="">-- Elige una opci√≥n --</option>
                    ${variables.map(variable => `<option value="${variable}">${variable}</option>`).join('')}
                </select>
                <div class="form-text mt-2">üí° Selecciona tu color o material preferido</div>
            `;
        } else {
            contenedor.innerHTML = '';
            verificarEstadoBotonAgregar();
        }
    }

    function renderizarTallas(producto) {
        const contenedor = document.getElementById('seccion-tallas');
        
        const necesitaTallas = producto.tallas && 
                             producto.tallas.trim() !== "" && 
                             producto.tallas !== "N/A" && 
                             !["√∫nica", "unica"].includes(producto.tallas.toLowerCase());

        if (necesitaTallas) {
            const tallas = producto.tallas.split(",").map(t => t.trim()).filter(t => t);
            
            contenedor.innerHTML = `
                <h5 class="fw-bold mb-3">üìè Selecciona tu talla</h5>
                <select class="form-select selector-talla" onchange="seleccionarTalla(this.value)" style="max-width: 250px; font-size: 1rem; padding: 10px;">
                    <option value="">-- Elige una talla --</option>
                    ${tallas.map(talla => `<option value="${talla}">${talla}</option>`).join('')}
                </select>
                <div class="form-text mt-2">üí° Aseg√∫rate de seleccionar tu talla correcta</div>
            `;
        } else {
            contenedor.innerHTML = '';
            verificarEstadoBotonAgregar();
        }
    }

    function seleccionarVariable(variable) {
        variableSeleccionada = variable;
        verificarEstadoBotonAgregar();
    }

    function seleccionarTalla(talla) {
        tallaSeleccionada = talla;
        verificarEstadoBotonAgregar();
    }

    function verificarEstadoBotonAgregar() {
        const btnAgregar = document.getElementById('btn-agregar-carrito');
        const btnComprar = document.querySelector('.btn-gradient');
        
        const necesitaVariables = productoActual?.variables && 
                                productoActual.variables.trim() !== "" && 
                                productoActual.variables !== "N/A" &&
                                !["√∫nica", "unica"].includes(productoActual.variables.toLowerCase());
        
        const necesitaTallas = productoActual?.tallas && 
                             productoActual.tallas.trim() !== "" && 
                             productoActual.tallas !== "N/A" && 
                             !["√∫nica", "unica"].includes(productoActual.tallas.toLowerCase());
        
        let puedeAgregar = varianteSeleccionada;
        
        if (necesitaVariables) {
            puedeAgregar = puedeAgregar && variableSeleccionada;
        }
        
        if (necesitaTallas) {
            puedeAgregar = puedeAgregar && tallaSeleccionada;
        }
        
        if (btnAgregar) {
            btnAgregar.disabled = !puedeAgregar;
            if (!varianteSeleccionada) {
                btnAgregar.innerHTML = '<i class="bi bi-image"></i> Selecciona un color';
            } else if (necesitaVariables && !variableSeleccionada) {
                btnAgregar.innerHTML = '<i class="bi bi-palette"></i> Selecciona color/material';
            } else if (necesitaTallas && !tallaSeleccionada) {
                btnAgregar.innerHTML = '<i class="bi bi-rulers"></i> Selecciona talla';
            } else {
                btnAgregar.innerHTML = '<i class="bi bi-cart-plus"></i> Agregar al carrito';
            }
        }
        
        if (btnComprar) btnComprar.disabled = !puedeAgregar;
    }

    function cambiarCantidad(delta) {
        cantidad = parseInt(document.getElementById('input-cantidad').value) + delta;
        cantidad = Math.max(1, Math.min(10, cantidad));
        document.getElementById('input-cantidad').value = cantidad;
    }

    function agregarAlCarrito() {
        if (!productoActual) {
            mostrarAlertaTemporal('‚ùå Error: El producto no se carg√≥ correctamente', 'danger');
            return false;
        }
        
        if (!varianteSeleccionada) {
            mostrarAlertaTemporal('‚ö†Ô∏è Por favor selecciona un color', 'warning');
            document.getElementById('galeria-miniaturas').scrollIntoView({ behavior: 'smooth' });
            return false;
        }

        const necesitaVariables = productoActual?.variables && 
                                productoActual.variables.trim() !== "" && 
                                productoActual.variables !== "N/A" &&
                                !["√∫nica", "unica"].includes(productoActual.variables.toLowerCase());
        
        const necesitaTallas = productoActual?.tallas && 
                             productoActual.tallas.trim() !== "" && 
                             productoActual.tallas !== "N/A" && 
                             !["√∫nica", "unica"].includes(productoActual.tallas.toLowerCase());
        
        if (necesitaVariables && !variableSeleccionada) {
            mostrarAlertaTemporal('‚ö†Ô∏è Por favor selecciona un color/material', 'warning');
            document.getElementById('seccion-variables').scrollIntoView({ behavior: 'smooth' });
            return false;
        }

        if (necesitaTallas && !tallaSeleccionada) {
            mostrarAlertaTemporal('‚ö†Ô∏è Por favor selecciona una talla', 'warning');
            document.getElementById('seccion-tallas').scrollIntoView({ behavior: 'smooth' });
            return false;
        }

        const precioFinal = calcularPrecioConDescuento(productoActual);
        const estaEnPromo = vieneDePromociones() || estaEnPromocionActual(productoActual.id);
        
        const productoCarrito = {
            id: productoActual.id + 
                '-' + varianteSeleccionada + 
                (variableSeleccionada ? '-' + variableSeleccionada.replace(/\s+/g, '_') : '') +
                (tallaSeleccionada ? '-' + tallaSeleccionada : ''),
            nombre: `${productoActual.producto} - ${varianteSeleccionada}` +
                    (variableSeleccionada ? ` - ${variableSeleccionada}` : '') +
                    (tallaSeleccionada ? ` - Talla ${tallaSeleccionada}` : ''),
            precio: precioFinal,
            imagen: imagenSeleccionada,
            variante: varianteSeleccionada,
            variable: variableSeleccionada || '√önica',
            talla: tallaSeleccionada || '√önica',
            cantidad: cantidad,
            enPromocion: estaEnPromo,
            precioOriginal: productoActual.precio || 0,
            vieneDePromociones: vieneDePromociones()
        };

        if (window.carritoManager && typeof window.carritoManager.agregarProducto === 'function') {
            const resultado = window.carritoManager.agregarProducto(productoCarrito);
            if (resultado) {
                mostrarConfirmacionAgregado();
                return true;
            } else {
                mostrarAlertaTemporal('‚ùå Error al agregar al carrito', 'danger');
                return false;
            }
        } else {
            try {
                const carrito = JSON.parse(localStorage.getItem('carritoAnmago') || '[]');
                const existeIndex = carrito.findIndex(item => item.id === productoCarrito.id);
                
                if (existeIndex > -1) {
                    carrito[existeIndex].cantidad += productoCarrito.cantidad;
                } else {
                    carrito.push(productoCarrito);
                }
                
                localStorage.setItem('carritoAnmago', JSON.stringify(carrito));
                actualizarContadoresCarrito();
                mostrarConfirmacionAgregado();
                return true;
                
            } catch (error) {
                mostrarAlertaTemporal('‚ùå Error cr√≠tico al agregar al carrito', 'danger');
                return false;
            }
        }
    }

    function comprarAhora() {
        if (!varianteSeleccionada) {
            mostrarAlertaTemporal('‚ö†Ô∏è Por favor selecciona un color', 'warning');
            return;
        }

        const necesitaVariables = productoActual?.variables && 
                                productoActual.variables.trim() !== "" && 
                                productoActual.variables !== "N/A" &&
                                !["√∫nica", "unica"].includes(productoActual.variables.toLowerCase());
        
        const necesitaTallas = productoActual?.tallas && 
                             productoActual.tallas.trim() !== "" && 
                             productoActual.tallas !== "N/A" && 
                             !["√∫nica", "unica"].includes(productoActual.tallas.toLowerCase());
        
        if (necesitaVariables && !variableSeleccionada) {
            mostrarAlertaTemporal('‚ö†Ô∏è Por favor selecciona un color/material', 'warning');
            return;
        }

        if (necesitaTallas && !tallaSeleccionada) {
            mostrarAlertaTemporal('‚ö†Ô∏è Por favor selecciona una talla', 'warning');
            return;
        }

        if (agregarAlCarrito()) {
            setTimeout(() => {
                abrirFormularioPedido();
            }, 500);
        }
    }

    function mostrarConfirmacionAgregado() {
        const btn = document.getElementById('btn-agregar-carrito');
        const originalText = btn.innerHTML;
        
        btn.innerHTML = '<i class="bi bi-check2"></i> ¬°Agregado!';
        btn.classList.remove('btn-agregar-carrito');
        btn.classList.add('btn-success');
        
        setTimeout(() => {
            btn.innerHTML = originalText;
            btn.classList.remove('btn-success');
            btn.classList.add('btn-agregar-carrito');
        }, 2000);
    }

    function mostrarAlertaTemporal(mensaje, tipo = 'warning') {
        const alertaExistente = document.querySelector('.alerta-temporal');
        if (alertaExistente) alertaExistente.remove();
        
        const alerta = document.createElement('div');
        alerta.className = `alert alert-${tipo} alert-dismissible fade show alerta-temporal position-fixed`;
        alerta.style.cssText = `
            top: 20px; 
            right: 20px; 
            z-index: 9999; 
            min-width: 300px; 
            max-width: 400px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            animation: slideIn 0.3s ease;
        `;
        
        alerta.innerHTML = `
            <div class="d-flex align-items-center">
                <i class="bi ${tipo === 'success' ? 'bi-check-circle' : tipo === 'danger' ? 'bi-exclamation-triangle' : 'bi-info-circle'} me-2 fs-5"></i>
                <div class="flex-grow-1">${mensaje}</div>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="alert" aria-label="Cerrar"></button>
            </div>
        `;
        
        document.body.appendChild(alerta);
        
        setTimeout(() => {
            if (alerta.parentNode) alerta.remove();
        }, 4000);
    }

    function renderizarBadges(producto, estaEnPromo) {
        const contenedor = document.getElementById('badges-producto');
        const badges = [];

        if (estaEnPromo) {
            badges.push('<span class="badge bg-danger me-2">üî• Oferta Activa</span>');
        }
        
        if (producto.nuevo) {
            badges.push('<span class="badge bg-success me-2">üÜï Nuevo</span>');
        }
        
        if (producto.stock <= 5 && producto.stock > 0) {
            badges.push('<span class="badge bg-warning me-2">‚ö†Ô∏è √öltimas unidades</span>');
        }

        contenedor.innerHTML = badges.join('');
    }

    function renderizarVideo(producto) {
        const contenedorDesktop = document.getElementById('video-producto-desktop');
        const contenedorMobile = document.getElementById('video-producto-mobile');
        
        if (!producto.video_url) {
            contenedorDesktop.style.display = 'none';
            contenedorMobile.style.display = 'none';
            return;
        }

        function convertirUrlYouTube(url) {
            if (url.includes('youtube.com/embed')) return url;
            
            if (url.includes('youtube.com') || url.includes('youtu.be')) {
                let videoId = '';
                
                if (url.includes('youtube.com/watch?v=')) {
                    videoId = url.split('v=')[1]?.split('&')[0];
                } else if (url.includes('youtu.be/')) {
                    videoId = url.split('youtu.be/')[1]?.split('?')[0];
                } else if (url.includes('youtube.com/shorts/')) {
                    videoId = url.split('shorts/')[1]?.split('?')[0];
                }
                
                if (videoId) return `https://www.youtube.com/embed/${videoId}`;
            }
            
            return url;
        }

        const videoUrlEmbed = convertirUrlYouTube(producto.video_url);
        const videoHTML = `
            <div class="mb-4">
                <h5 class="fw-bold mb-3">üé• Video del producto</h5>
                <div class="ratio ratio-16x9">
                    <iframe 
                        src="${videoUrlEmbed}" 
                        title="Video del producto: ${producto.producto}"
                        class="rounded shadow"
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                        allowfullscreen>
                    </iframe>
                </div>
                <div class="text-center mt-2">
                    <small class="text-muted">
                        <i class="bi bi-play-circle"></i> Haz clic para ver el video del producto
                    </small>
                </div>
            </div>
        `;

        contenedorDesktop.innerHTML = videoHTML;
        contenedorMobile.innerHTML = videoHTML;
        contenedorDesktop.style.display = '';
        contenedorMobile.style.display = '';
    }

    function cargarProductosRelacionados(productos, productoActual) {
        const relacionados = productos
            .filter(p => p.id !== productoActual.id && 
                (p.tipo === productoActual.tipo || 
                 p.categoria === productoActual.categoria))
            .slice(0, 4);

        const contenedor = document.getElementById('productos-relacionados');
        
        if (relacionados.length === 0) {
            contenedor.innerHTML = '<p class="text-muted text-center py-4">No hay productos relacionados</p>';
            return;
        }

        contenedor.innerHTML = relacionados.map(producto => {
            const precioBase = producto.precio || 0;
            const precioMostrar = calcularPrecioConDescuento(producto);
            const estaEnPromo = precioMostrar < precioBase;
            
            return `
            <div class="card-producto-ml">
                <a href="PRODUCTO.HTML?id=${producto.id}">
                    <img src="${producto.imagen}" alt="${producto.producto}" class="card-img-ml imagen-completa">
                    <div class="card-body-ml">
                        <h3 class="nombre-producto-ml small line-clamp-2">${producto.producto}</h3>
                        <div class="d-flex align-items-center gap-2">
                            <p class="precio-ml fw-bold text-primary mb-0">$${precioMostrar.toLocaleString('es-CO')}</p>
                            ${estaEnPromo ? 
                            `<span class="text-muted small text-decoration-line-through">$${precioBase.toLocaleString('es-CO')}</span>
                            <span class="badge bg-danger small">-${Math.round((1 - precioMostrar/precioBase) * 100)}%</span>` 
                            : ''}
                        </div>
                        <span class="btn btn-outline-primary btn-sm mt-2">Ver detalle</span>
                    </div>
                </a>
            </div>
            `;
        }).join('');
    }

    function mostrarError(mensaje) {
        const main = document.querySelector('main');
        main.innerHTML = `
            <div class="container py-5">
                <div class="row justify-content-center">
                    <div class="col-md-6 text-center">
                        <i class="bi bi-emoji-frown fs-1 text-muted mb-4"></i>
                        <h3 class="h4 text-muted mb-3">${mensaje}</h3>
                        <p class="text-muted mb-4">Estamos teniendo problemas t√©cnicos. Por favor intenta:</p>
                        
                        <div class="d-grid gap-2 d-md-flex justify-content-center">
                            <button class="btn btn-primary" onclick="location.reload()">
                                <i class="bi bi-arrow-clockwise"></i> Reintentar
                            </button>
                            <a href="INICIO.HTML" class="btn btn-outline-primary">
                                <i class="bi bi-house"></i> Volver al inicio
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    function actualizarContadoresCarrito() {
        const carrito = JSON.parse(localStorage.getItem('carritoAnmago') || '[]');
        const totalItems = carrito.reduce((total, item) => total + (item.cantidad || 1), 0);
        
        ['contador-carrito', 'contador-carrito-mobile'].forEach(id => {
            const elemento = document.getElementById(id);
            if (elemento) {
                elemento.textContent = totalItems;
                elemento.style.display = totalItems > 0 ? 'block' : 'none';
            }
        });
    }

    function abrirFormularioPedido() {
        window.location.href = 'modalformulario.html';
    }

    // ========== FUNCIONES GLOBALES ==========
    window.volverAtras = volverAtras;
    window.seleccionarImagenPrincipal = seleccionarImagenPrincipal;
    window.seleccionarVariable = seleccionarVariable;
    window.seleccionarTalla = seleccionarTalla;
    window.cambiarCantidad = cambiarCantidad;
    window.agregarAlCarrito = agregarAlCarrito;
    window.comprarAhora = comprarAhora;
    window.seleccionarImagenModal = seleccionarImagenModal;
    window.navegarImagenModal = navegarImagenModal;
    window.seleccionarDesdeModal = seleccionarDesdeModal;
    window.abrirFormularioPedido = abrirFormularioPedido;
  </script>

  <!-- SCRIPTS EXTERNOS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="buscador.js?v=20251115"></script>
</body>
</html>